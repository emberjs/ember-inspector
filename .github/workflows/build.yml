name: Build and Publish
on:
  pull_request: {}
  push:
    branches:
      - master
      - stable
      - ember-2.7.0-3.4.0
      - ember-0.0.0-2.7.0
    tags:
      - v*
  schedule:
    - cron: '0 0 * * *'

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Set up Volta
        uses: rwjblue/setup-volta@v1
      - name: Set up build cache (yarn)
        uses: actions/cache@v1
        with:
          path: ~/.cache/yarn
          key: ${{ runner.os }}-yarn
      - name: Install dependencies (yarn)
        run: yarn install
      - name: Lint (hbs)
        run: yarn lint:hbs
      - name: Lint (js)
        run: yarn lint:js
      - name: Tests
        run: yarn test
      - name: Report Coverage
        run: yarn codeclimate-test-reporter < coverage/lcov.info
        env:
          CODECLIMATE_REPO_TOKEN: 59edcfd1ffc778791af49ca594b503e7179f6bbe1991b2cc0c0a6987d103253d

  ember-try-default:
    name: ember-try (default)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Set up Volta
        uses: rwjblue/setup-volta@v1
      - name: Set up build cache (yarn)
        uses: actions/cache@v1
        with:
          path: ~/.cache/yarn
          key: ${{ runner.os }}-yarn
      - name: Install dependencies (yarn)
        run: yarn install
      - name: Run ember-try
        run: yarn ember try:one ember-default --- ember test --filter="Ember Debug"

  ember-try-release:
    name: ember-try (release)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Set up Volta
        uses: rwjblue/setup-volta@v1
      - name: Set up build cache (yarn)
        uses: actions/cache@v1
        with:
          path: ~/.cache/yarn
          key: ${{ runner.os }}-yarn
      - name: Install dependencies (yarn)
        run: yarn install
      - name: Run ember-try
        run: yarn ember try:one ember-release --- ember test --filter="Ember Debug"

  ember-try-beta:
    name: ember-try (beta)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Set up Volta
        uses: rwjblue/setup-volta@v1
      - name: Set up build cache (yarn)
        uses: actions/cache@v1
        with:
          path: ~/.cache/yarn
          key: ${{ runner.os }}-yarn
      - name: Install dependencies (yarn)
        run: yarn install
      - name: Run ember-try
        run: yarn ember try:one ember-beta --- ember test --filter="Ember Debug"

  ember-try-canary:
    name: ember-try (canary)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Set up Volta
        uses: rwjblue/setup-volta@v1
      - name: Set up build cache (yarn)
        uses: actions/cache@v1
        with:
          path: ~/.cache/yarn
          key: ${{ runner.os }}-yarn
      - name: Install dependencies (yarn)
        run: yarn install
      - name: Run ember-try
        run: yarn ember try:one ember-canary --- ember test --filter="Ember Debug"

  ember-try-lts-3-4:
    name: ember-try (LTS 3.4)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Set up Volta
        uses: rwjblue/setup-volta@v1
      - name: Set up build cache (yarn)
        uses: actions/cache@v1
        with:
          path: ~/.cache/yarn
          key: ${{ runner.os }}-yarn
      - name: Install dependencies (yarn)
        run: yarn install
      - name: Run ember-try
        run: yarn ember try:one ember-lts-3.4 --- ember test --filter="Ember Debug"

  ember-try-lts-3-8:
    name: ember-try (LTS 3.8)
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Set up Volta
        uses: rwjblue/setup-volta@v1
      - name: Set up build cache (yarn)
        uses: actions/cache@v1
        with:
          path: ~/.cache/yarn
          key: ${{ runner.os }}-yarn
      - name: Install dependencies (yarn)
        run: yarn install
      - name: Run ember-try
        run: yarn ember try:one ember-lts-3.8 --- ember test --filter="Ember Debug"

  build:
    name: Build for publishing
    needs:
      - ember-try-default
      - ember-try-release
      - ember-try-beta
      - ember-try-canary
      - ember-try-lts-3-4
      - ember-try-lts-3-8
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v1
      - name: Set up Volta
        uses: rwjblue/setup-volta@v1
      - name: Set up build cache (yarn)
        uses: actions/cache@v1
        with:
          path: ~/.cache/yarn
          key: ${{ runner.os }}-yarn
      - name: Install dependencies (yarn)
        run: yarn install
      - name: Build
        run: yarn build:production
      - name: Upload artifacts (bookmarklet)
        uses: actions/upload-artifact@master
        with:
          name: bookmarklet
          path: dist/bookmarklet
      - name: Upload artifacts (chrome)
        uses: actions/upload-artifact@master
        with:
          name: chrome
          path: dist/chrome
      - name: Upload artifacts (firefox)
        uses: actions/upload-artifact@master
        with:
          name: firefox
          path: dist/firefox

  publish-bookmarklet:
    name: Publish bookmarklet
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts (bookmarklet)
        uses: actions/download-artifact@master
        with:
          name: bookmarklet
      - name: Upload to S3
        uses: jakejarvis/s3-sync-action@master
        with:
          args: --acl public-read --delete --cache-control "max-age=86400000, public"
        env:
          AWS_S3_BUCKET: ember-extension
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          SOURCE_DIR: bookmarklet
          DEST_DIR: dist_bookmarklet
